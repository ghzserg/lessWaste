# printer modifications

[extruder]
pressure_advance:0.042

[lis2dw]
spi_speed: 100000

[stepper_x]
microsteps: 64

[stepper_y]
microsteps: 64

[stepper_z]
microsteps: 64

[extruder]
microsteps: 64

[tmc2209 extruder]
interpolate:False

[tmc2209 stepper_x]
interpolate:False

[tmc2209 stepper_y]
interpolate:False

[tmc2209 stepper_z]
interpolate:False

[printer]
max_velocity: 500
max_accel: 8000
square_corner_velocity: 5

[probe]                                             
samples: 2
samples_tolerance:0.05
samples_tolerance_retries:5
lift_speed:15
sample_retract_dist:3

[bed_mesh]                         
speed: 300
probe_count: 5, 5
horizontal_move_z:2

[screws_tilt_adjust]
screw1: 12.5, 12.5
screw1_name: Left Near
screw2: 202, 12.5
screw2_name: Right Near
screw3: 202, 202
screw3_name: Right Far
screw4: 12.5, 202
screw4_name: Left Far
horizontal_move_z: 2
speed: 300
screw_thread: CCW-M3

[zmod_ifs]
debug: False

[zmod_ifs_switch_sensor head_switch_sensor]
pause_on_runout: False
runout_gcode:
    _RUNOUT_HEAD

[zmod_ifs_motion_sensor ifs_motion_sensor]
pause_on_runout: False
runout_gcode:
    _RUNOUT_MOTION

[zmod_ifs_motion_sensor _ifs_motion_sensor_1]
pause_on_runout: False
port:1

[zmod_ifs_motion_sensor _ifs_motion_sensor_2]
pause_on_runout: False
port:2

[zmod_ifs_motion_sensor _ifs_motion_sensor_3]
pause_on_runout: False
port:3

[zmod_ifs_motion_sensor _ifs_motion_sensor_4]
pause_on_runout: False
port:4

[zmod_ifs_switch_sensor _ifs_port_sensor_1]
pause_on_runout: False
type:port
port:1
runout_gcode:
    _RUNOUT_PORT PORT=1
insert_gcode:
    _IFS_INSERT PORT=1

[zmod_ifs_switch_sensor _ifs_port_sensor_2]
pause_on_runout: False
type:port
port:2
runout_gcode:
    _RUNOUT_PORT PORT=2
insert_gcode:
    _IFS_INSERT PORT=2

[zmod_ifs_switch_sensor _ifs_port_sensor_3]
pause_on_runout: False
type:port
port:3
runout_gcode:
    _RUNOUT_PORT PORT=3
insert_gcode:
    _IFS_INSERT PORT=3

[zmod_ifs_switch_sensor _ifs_port_sensor_4]
pause_on_runout: False
type:port
port:4
runout_gcode:
    _RUNOUT_PORT PORT=4
insert_gcode:
    _IFS_INSERT PORT=4

[gcode_macro _RUNOUT_MOTION]
gcode:
    {% if printer.print_stats.state == "printing" %}
      {% set ifs = printer['gcode_macro _IFS_VARS'] %}
        PAUSE REASON="jam"
    {% endif %}

[gcode_macro _RUNOUT_HEAD]
gcode:
    {% if printer.print_stats.state == "printing" %}
      {% set ifs = printer['gcode_macro _IFS_VARS'] %}
      {% if printer['filament_switch_sensor _ifs_port_sensor_'+ifs.extruder_port|string].filament_detected %}
        SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=consume VALUE=0
        PAUSE REASON="broken"
        _IFS_VARS extruder_port=0
      {% else %}
        {% if ifs.backup == 1 and ifs.consume > 0 %} #make sure we came from a runout port triggering consume
          #check colors match, types match, and spent status
          #variable_types:['PLA','PLA','PLA','PLA']
          #variable_colors:['000000','000000','000000','000000']
          #variable_backup_filament_spent:[0,0,0,0] # mark as 1 when index not used in backup, all ones when backup disabled
          {% set ns = namespace(port_found = 0) %}
          {% for index in range(0,4) %}
            {% if (ifs.extruder_port)-1 != index %}
              {% if ifs.types[(ifs.extruder_port)-1] == ifs.types[index] %}
                {% if ifs.colors[(ifs.extruder_port)-1] == ifs.colors[index] %}
                  {% if ifs.backup_filament_spent[index] == 0 %}
                    {% if ns.port_found == 0 %}
                      # assign port to current tool
                      _IFS_COLORS_ASSIGN TOOL={ifs.current_tool} PORT={index+1} DIALOG=0
                      #_INFO_DIALOG TITLE="Backup" MSG="Run out filament (Head) ({ifs.extruder_port|string}), backup, loading {index + 1} and continuing with printing..." CLOSE=1
                      SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=consume VALUE=0
                      PAUSE reason="backup" 
                      #set the spent status for the old port
                      {% set fs = namespace(spent_temp = []) %}
                      {% for val in ifs.backup_filament_spent %}
                        {% if loop.index0 == (ifs.extruder_port)-1 %}
                          {% set _ = fs.spent_temp.append(1) %}
                        {% else %}
                          {% set _ = fs.spent_temp.append(val) %}
                        {% endif %}
                      {% endfor %}
                      SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=backup_filament_spent VALUE='{fs.spent_temp}'
                      _IFS_VARS extruder_port={index+1}
                      {% set ns.port_found = 1 %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endif %}      
          {% endfor %}
          {% if ns.port_found == 0 %} #if nothing found in backups
            _INFO_DIALOG TITLE="Backup" MSG="用完灯丝（头） ({ifs.extruder_port|string}), tool ({ifs.current_tool|string}) 已启用备份" CLOSE=1
            SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=consume VALUE=0
            PAUSE REASON="runout"
            #_IFS_VARS extruder_port=0
          {% endif %}
        {% else %} #if backup is disabled
          _INFO_DIALOG TITLE="Backup" MSG="用完灯丝（头） ({ifs.extruder_port|string}), tool ({ifs.current_tool|string}) 备份已禁用" CLOSE=1
          SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=consume VALUE=0
          PAUSE REASON="runout"
          #_IFS_VARS extruder_port=0
        {% endif %}
      {% endif %}
    {% endif %}

[gcode_macro _RUNOUT_PORT]
gcode:
  {% set port = params.PORT|default(0)|int %}
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  
  {% if printer.print_stats.state == "printing" %}
    {% if port == ifs.extruder_port %}
        {% if port > 0 %}
            {% if printer['filament_motion_sensor _ifs_motion_sensor_'+port|string].filament_detected %}
                RESPOND PREFIX="info" MSG="IFS 中的灯丝耗尽 ({port|string}) 检测到"
                # it was moving, so we disable motion sensor
                SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=0
                SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=consume VALUE={port}
            {% endif %}
        {% endif %}
    {% endif %}
  {% else %}
    {% if printer['gcode_macro _IFS_COLORS'].open == 1 %}
      UPDATE_DELAYED_GCODE ID=_IFS_COLORS_DELAYED DURATION=1
    {% endif %}
  {% endif %}

[gcode_macro _IFS_INSERT]
gcode:
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}
    {% if not printer.print_stats.state == "printing" %}
        {% set port = params.PORT|default(0)|int %}
        {% set filament_autoinsert_full_length = params.FILAMENT_AUTOINSERT_FULL_LENGTH|default(ifs.filament_autoinsert_full_length)|int %}
        {% set filament_home_speed = params.FILAMENT_HOME_SPEED|default(ifs.filament_home_speed)|int %}
        {% set filament_insert_speed = params.FILAMENT_INSERT_SPEED|default(ifs.filament_insert_speed)|int %}
        {% set filament_tube_length = params.FILAMENT_TUBE_LENGTH|default(ifs.filament_tube_length)|int %}
        {% set filament_unload_speed = params.FILAMENT_UNLOAD_SPEED|default(ifs.filament_unload_speed)|int %}
        {% set nozzle_cleaning_length = params.NOZZLE_CLEANING_LENGTH|default(ifs.nozzle_cleaning_length)|int %}

        #_INFO_DIALOG TITLE="Insert filament detected" MSG="Auto insert: {port} ..."
        IFS_F24 PRUTOK={port}
        IFS_F10 PRUTOK={port} LEN={filament_autoinsert_full_length} SPEED={filament_insert_speed}
        {% if not printer['filament_switch_sensor head_switch_sensor'].filament_detected %}
            IFS_F10 PRUTOK={port} LEN={filament_tube_length} SPEED={filament_home_speed} CHECK=1 # Homering the filament no printing
            IFS_F11 PRUTOK={port} LEN={nozzle_cleaning_length} SPEED={filament_unload_speed}
        {% endif %}
        IFS_F39 PRUTOK={port}
        {% if printer['gcode_macro _IFS_COLORS'].open == 1 %}
          UPDATE_DELAYED_GCODE ID=_IFS_COLORS_DELAYED DURATION=1
        {% else %}
          RESPOND TYPE=command MSG="action:prompt_end"
        {% endif %}
        # Reset backup status when inserting filament
        {% set port = params.PORT|default(0)|int %}
        {% set fs = namespace(spent_temp = []) %}
        {% for val in ifs.backup_filament_spent %}
          {% if loop.index0 == port-1 %}
            {% set _ = fs.spent_temp.append(0) %}
          {% else %}
            {% set _ = fs.spent_temp.append(val) %}
          {% endif %}
        {% endfor %}
        SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=backup_filament_spent VALUE='{fs.spent_temp}'
        RESPOND PREFIX="info" MSG="备份端口的消耗状态 {port|string} 重置."
    {% endif %}

# manage leftover filament when runout
[gcode_macro _CONSUME]
gcode:
  {% set consume = printer['gcode_macro _IFS_VARS'].consume %}

  {% if consume > 0 %}
    # Disable HEAD sensor because it will activate PAUSE
    SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=0
    {% for i in range(20) %}
      # We extrude 50 mm * 20 = 1 meter or less if the filament in the head runs out
      #_INFO_DIALOG TITLE="Poop {i}/20" MSG="The filament in the IFS ({consume}) has run out. Purging the tube"
      M400 #try to mitigate timer too close
      _CONSUME_CHECK_AND_POOP # We need this call to check the sensor in Head every so often
    {% endfor %}
    RESPOND TYPE=command MSG="action:prompt_end"
    _IFS_VARS extruder_port=0
    SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=consume VALUE=0
    SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=1
  {% endif %}

[gcode_macro _CONSUME_CHECK_AND_POOP]
gcode:
    {% if printer['filament_switch_sensor head_switch_sensor'].filament_detected %}
        {% set ifs = printer['gcode_macro _IFS_VARS'] %}
        POOP FLUSH_LENGTH=50 E_FEEDRATE={ifs.e_feedrate}
    {% endif %}

# Check the status of the filaments in the IFS ports.

[gcode_macro _CHECK_FILAMENT]
variable_check_0: 0

gcode:
    _IFS_VARS extruder_port=0
    {% if printer['filament_switch_sensor head_switch_sensor'].filament_detected %}
      {% if (printer['filament_switch_sensor _ifs_port_sensor_1'].filament_detected + 
        printer['filament_switch_sensor _ifs_port_sensor_2'].filament_detected + 
        printer['filament_switch_sensor _ifs_port_sensor_3'].filament_detected + 
        printer['filament_switch_sensor _ifs_port_sensor_4'].filament_detected) == 1 %}
        # Only one port on the IFS has filament
        {% if printer['filament_switch_sensor _ifs_port_sensor_1'].filament_detected %}
          _IFS_VARS extruder_port=1
        {% elif printer['filament_switch_sensor _ifs_port_sensor_2'].filament_detected %}
          _IFS_VARS extruder_port=2
        {% elif printer['filament_switch_sensor _ifs_port_sensor_3'].filament_detected %}
          _IFS_VARS extruder_port=3
        {% elif printer['filament_switch_sensor _ifs_port_sensor_4'].filament_detected %}
          _IFS_VARS extruder_port=4
        {% endif %}
      {% else %}
        SET_GCODE_VARIABLE MACRO=_CHECK_FILAMENT VARIABLE=check_0 VALUE=1
        # We pulled each slot a little bit in case one of them was just activating the sensor without being gripped by the extruder.
        _INFO_DIALOG TITLE="Checking filaments - Auto recovery" MSG="挤出机灯丝传感器已触发，不是预期的。检查灯丝是否被切断..."
        {% if printer['filament_switch_sensor _ifs_port_sensor_1'].filament_detected %}
          IFS_F24 PRUTOK=1
          IFS_F11 PRUTOK=1 LEN=20 SPEED=600
        {% endif %}
        {% if printer['filament_switch_sensor _ifs_port_sensor_2'].filament_detected %}
          IFS_F24 PRUTOK=2
          IFS_F11 PRUTOK=2 LEN=20 SPEED=600
        {% endif %}
        {% if printer['filament_switch_sensor _ifs_port_sensor_3'].filament_detected %}
          IFS_F24 PRUTOK=3
          IFS_F11 PRUTOK=3 LEN=20 SPEED=600
        {% endif %}
        {% if printer['filament_switch_sensor _ifs_port_sensor_4'].filament_detected %}
          IFS_F24 PRUTOK=4
          IFS_F11 PRUTOK=4 LEN=20 SPEED=600
        {% endif %}
        IFS_F39 PRUTOK=4
        _CHECK_FILAMENT_0 #required: check the sensor head in other macro, not in this
        _CHECK_FILAMENT_1 #required: check the sensor head in other macro, not in this
        _CHECK_FILAMENT_2 #required: check the _ifs_motion_sensor_x in other macro, not in this
        RESPOND TYPE=command MSG="action:prompt_end"
        #_INFO_DIALOG TITLE="Backup" MSG="如果需要，手动将灯丝推回到4-1内的准备位置" CLOSE=1
      {% endif %}
    {% endif %}
    _IFS_VARS extruder_port=?
    SET_GCODE_VARIABLE MACRO=_CHECK_FILAMENT VARIABLE=check_0 VALUE=0

[gcode_macro _CHECK_FILAMENT_0]
gcode:
    {% if not printer['filament_switch_sensor head_switch_sensor'].filament_detected and printer['gcode_macro _CHECK_FILAMENT'].check_0 %}
      # one of them was just activating the sensor so we retract 45mm all of them.
        _INFO_DIALOG TITLE="Checking filaments - Auto recovery" MSG="其中一根细丝被挤出机夹住，全部收缩 45 毫米以寻找罪魁祸首......"
        IFS_F24 PRUTOK=1
        IFS_F11 PRUTOK=1 LEN=45 SPEED=600
        IFS_F24 PRUTOK=2
        IFS_F11 PRUTOK=2 LEN=45 SPEED=600
        IFS_F24 PRUTOK=3
        IFS_F11 PRUTOK=3 LEN=45 SPEED=600
        IFS_F24 PRUTOK=4
        IFS_F11 PRUTOK=4 LEN=45 SPEED=600
        IFS_F39 PRUTOK=4
    {% endif %}

[gcode_macro _CHECK_FILAMENT_1]
gcode:
    {% if printer['filament_switch_sensor head_switch_sensor'].filament_detected %}
        {% set flush_length = 45 %}
        _INFO_DIALOG TITLE="Checking filaments - Auto recovery" MSG="其中一根细丝被挤出机夹住，因此我们挤出 {flush_length|string}mm 以确定它是哪一个..."
        _DISABLE_SENSORS
        POOP FLUSH_LENGTH={flush_length}
        M400
        _ENABLE_SENSORS
    {% endif %}

[gcode_macro _CHECK_FILAMENT_2]
gcode:
    # we check what filament move in the ifs motion sensor and that is the extruder_port 
    {% if printer['filament_switch_sensor head_switch_sensor'].filament_detected %}
      {% if printer['filament_motion_sensor _ifs_motion_sensor_1'].filament_detected %}
          _IFS_VARS extruder_port=1
      {% elif printer['filament_motion_sensor _ifs_motion_sensor_2'].filament_detected %}
          _IFS_VARS extruder_port=2
      {% elif printer['filament_motion_sensor _ifs_motion_sensor_3'].filament_detected %}
          _IFS_VARS extruder_port=3
      {% elif printer['filament_motion_sensor _ifs_motion_sensor_4'].filament_detected %}
          _IFS_VARS extruder_port=4
      {% endif %} 
    {% endif %}


# dialogs in mainsail to assign colors(tools) to ports in the IFS or print from external spool

[gcode_macro _IFS_COLORS_CANCEL]
gcode:
  RESPOND type="command" msg="action:prompt_end"
  SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=open VALUE=0

[gcode_macro _IFS_COLORS_PRINT]
gcode:
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}
    {% set ifs_colors = printer['gcode_macro _IFS_COLORS'] %}
    RESPOND type="command" msg="action:prompt_end"

    SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=open VALUE=0
    SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=start VALUE=0
    BASE_SDCARD_PRINT_FILE FILENAME="{ifs_colors.filename}"
    {% if ifs.kamp == 1 %}
      {ifs_colors.exclude}
    {% endif %}

[gcode_macro _IFS_COLORS_ASSIGN]
gcode:
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}
    {% set ifs_colors = printer['gcode_macro _IFS_COLORS'] %}
    {% set tool = params.TOOL|int %}
    {% set port = params.PORT|int %}
    {% set dialog = params.DIALOG|default(1)|int %}

    {% if tool == 0 %}
    {% set port1 = port %}
    {% else %}
        {% set port1 = ifs.tools[0] %}
    {% endif %}

    {% if tool == 1 %}
        {% set port2 = port %}
    {% else %}
        {% set port2 = ifs.tools[1] %}
    {% endif %}

    {% if tool == 2 %}
        {% set port3 = port %}
    {% else %}
        {% set port3 = ifs.tools[2] %}
    {% endif %}

    {% if tool == 3 %}
        {% set port4 = port %}
    {% else %}
        {% set port4 = ifs.tools[3] %}
    {% endif %}
    
    SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=tools VALUE=[{port1},{port2},{port3},{port4}]
    SAVE_VARIABLE VARIABLE=less_waste_tools VALUE=[{port1},{port2},{port3},{port4}]
    _IFS_VARS external=0

    _IFS_COLORS_PORT_TYPE PORT={port} TYPE={ifs_colors.types.split(',')[tool]}
    
    {% if dialog == 1 %}
      _IFS_COLORS
    {% endif %}

[gcode_macro _IFS_COLORS_IFS]
gcode:
   {% set external = params.EXTERNAL|int %}
  _IFS_VARS external={external}
  _IFS_VARS extruder_port=0
  _IFS_COLORS

[gcode_macro _IFS_COLORS_KAMP] #bed leveling
gcode:
  {% set kamp = params.KAMP|int %}
    
  _IFS_VARS kamp={kamp}
  _IFS_COLORS

[gcode_macro _IFS_COLORS_LINE_PURGE]
gcode:
  {% set line_purge = params.LINE_PURGE|int %}
    
  _IFS_VARS line_purge={line_purge}
  _IFS_COLORS

[gcode_macro _IFS_COLORS_INFO_DIALOG]
gcode:
  {% set info = params.INFO_DIALOG|int %}
    
  _IFS_VARS info_dialog={info}
  _IFS_COLORS

[gcode_macro _IFS_COLORS_BACKUP]
gcode:
  {% set backup = params.BACKUP|int %}
    
  _IFS_VARS backup={backup}
  _IFS_COLORS

[gcode_macro _IFS_COLORS_PORT_TYPE]
gcode:
  {% set port = params.PORT|int %}
  {% set type = params.TYPE|string %}
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  
  {% if port == 1 %}
    {% set type1 = type %}
  {% else %}
    {% set type1 = ifs.types[0] %}
  {% endif %}
  {% if port == 2 %}
    {% set type2 = type %}
  {% else %}
    {% set type2 = ifs.types[1] %}
  {% endif %}
  {% if port == 3 %}
    {% set type3 = type %}
  {% else %}
    {% set type3 = ifs.types[2] %}
  {% endif %}
  {% if port == 4 %}
    {% set type4 = type %}
  {% else %}
    {% set type4 = ifs.types[3] %}
  {% endif %}
  
  _IFS_VARS types="['{ type1 }','{ type2 }','{ type3 }','{ type4 }']"
  
[delayed_gcode _IFS_COLORS_DELAYED]
initial_duration:0
gcode:
  _IFS_COLORS

[gcode_macro _IFS_COLORS_NOTIFICATION]
gcode:
  {% set title = params.TITLE | default('title') %}
  {% set msg = params.MSG | default('message') %}

  _INFO_DIALOG TITLE={title} MSG="{msg}" CLOSE=1 CLOSE_ACTION="_IFS_COLORS"

[gcode_macro _IFS_COLORS]
variable_tools:[]
variable_colors:''
variable_types:''
variable_open:0
variable_filename:''
variable_exclude:''
variable_version:'0.0.0'
variable_skip:0

gcode:
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  {% set ifs_colors = printer['gcode_macro _IFS_COLORS'] %}

  {% if 'EXCLUDE' in params %}
    SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=exclude VALUE='"{params.EXCLUDE}"'
  {% endif %}

  {% if 'VERSION' in params %}
    {% set version_colors = params.VERSION.split('.') %}
    SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=version VALUE='"{params.VERSION}"'
  {% else %}
    {% set version_colors = ifs_colors.version.split('.') %}
  {% endif %}

  {% if 'START' in params %} # regardless of the value, if the START parameter is present, then it is the call from preprint.py script
    SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=start VALUE=1
    {% set start = 1 %}
  {% else %}
    {% set start = ifs.start %}
  {% endif %}

  {% if params.TOOLS is not defined %}
    {% set tools = ifs_colors.tools %}
  {% else %}
    {% set tools_param = params.TOOLS | default("") %}
    {% if tools_param | length == 0 or tools_param == "0" %}
      {% set tools = [0] %}
    {% else %}
      {% set tools = tools_param.split(',') %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=tools VALUE='{tools}'
  {% endif %}

  {% set colors = params.COLORS|default(0) %}
  {% if colors != 0 %}
    {% set colors = params.COLORS.split(',') %}
    SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=colors VALUE='"{params.COLORS}"'
  {% else %}
    {% set colors = ifs_colors.colors.split(',') %}
  {% endif %}
  SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=colors VALUE="['{colors[0]}','{colors[1]}','{colors[2]}','{colors[3]}']"

  {% set types = params.TYPES|default(0) %}
  {% if types != 0 %}
    {% set types = params.TYPES.split(',') %}
    SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=types VALUE='"{params.TYPES}"'
    SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=types VALUE="['{types[0]}','{types[1]}','{types[2]}','{types[3]}']"
  {% else %}
    {% set types = ifs_colors.types.split(',') %}
  {% endif %}


  {% if 'E_FEEDRATES' in params %}
    {% set e_feedrates = params.E_FEEDRATES.split(',') %}
    {% set ns = namespace(e_feedrates=[]) %}
    {% for tool in range(0,16) %}
      {% if tool|string in tools %}
        {% set val = e_feedrates[tool]|int %}
        {% set _ = ns.e_feedrates.append(810 if val > 810 else val) %}
      {% else %}
        {% set _ = ns.e_feedrates.append(130) %}
      {% endif %}
    {% endfor %}
    _IFS_VARS e_feedrates='{ns.e_feedrates}'
  {% endif %}
  
  RESPOND TYPE=command MSG="action:prompt_begin Color to Port"
  
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  {% if (ifs.kamp == 1) %}
    RESPOND TYPE=command MSG="action:prompt_button 调平：开|_IFS_COLORS_KAMP KAMP=0"
  {% else %}
    RESPOND TYPE=command MSG="action:prompt_button 调平：关|_IFS_COLORS_KAMP KAMP=1"
  {% endif %}

  {% if (ifs.line_purge == 1) %}
    RESPOND TYPE=command MSG="action:prompt_button L_PURGE：开|_IFS_COLORS_LINE_PURGE LINE_PURGE=0"
  {% else %}
    RESPOND TYPE=command MSG="action:prompt_button L_PURGE：关闭|_IFS_COLORS_LINE_PURGE LINE_PURGE=1"
  {% endif %}

  {% set ifs_external = ifs.external %}
  {% if ifs_external==1 and tools|length > 1 %}
    _IFS_VARS external=0
    {% set ifs_external = 0 %}
    RESPOND TYPE=command MSG="action:prompt_button IFS：开|_IFS_COLORS_NOTIFICATION TITLE='IFS' MSG='这是多色打印，无法禁用 IFS。'"
  {% elif ifs_external==0 and tools|length > 1 %}
    RESPOND TYPE=command MSG="action:prompt_button IFS：开|_IFS_COLORS_NOTIFICATION TITLE='IFS' MSG='这是多色打印，无法禁用 IFS。'"
  {% elif ifs_external==1 %}
    RESPOND TYPE=command MSG="action:prompt_button IFS：关闭|_IFS_COLORS_IFS EXTERNAL=0"
  {% else %}
    RESPOND TYPE=command MSG="action:prompt_button IFS：开|_IFS_COLORS_IFS EXTERNAL=1"
  {% endif %}

  {% set ifs_backup = ifs.backup %}
  {% if ifs_backup == 1 and ifs_external == 1 %}
    _IFS_VARS backup=0
    {% set ifs_backup = 0 %}
    RESPOND TYPE=command MSG="action:prompt_button 备份：关闭|_IFS_COLORS_NOTIFICATION TITLE='Backup' MSG='BACKUP 功能仅在启用 IFS 的情况下才可用。'"
  {% elif ifs_backup==0 and ifs_external == 1 %}
    RESPOND TYPE=command MSG="action:prompt_button 备份：关闭|_IFS_COLORS_NOTIFICATION TITLE='Backup' MSG='BACKUP 功能仅在启用 IFS 的情况下才可用。'"
  {% elif ifs_backup==1 %}  
    RESPOND TYPE=command MSG="action:prompt_button 备份：开|_IFS_COLORS_BACKUP BACKUP=0"
  {% else %}
    RESPOND TYPE=command MSG="action:prompt_button 备份：关闭|_IFS_COLORS_BACKUP BACKUP=1"
  {% endif %}

  {% if ifs.info_dialog == 1 %}
     RESPOND TYPE=command MSG="action:prompt_button 对话：开|_IFS_COLORS_INFO_DIALOG INFO_DIALOG=0"
  {% else %}
    RESPOND TYPE=command MSG="action:prompt_button 对话：关闭|_IFS_COLORS_INFO_DIALOG INFO_DIALOG=1"
  {% endif %}

  RESPOND TYPE=command MSG="action:prompt_button_group_end"

  # show Tools and colors, along with staus of ports and backups
  #Tools and colors
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  {% for index in range(4) %}
    {% set ns = namespace(skip=0) %} 
    {% for tool in tools %}
      #{% if ifs.tools[tool|int] == index|int+1 %}
      {% if ifs.tools[index|int] == ((tool|int)+1) %}
         {% set temp = "action:prompt_button T" ~ tool ~ "->" ~ types[index|int] ~ "|_SWAP_CHANNEL_DIALOG CHANNEL=" ~ (index+1)|string ~ "|primary|" ~ colors[index|int] %}
        RESPOND TYPE=command MSG="{temp}"
        {% set ns.skip = 1 %}
      {% endif %}
    {% endfor %}
    {% if ns.skip == 0 %}
      {% set temp = "action:prompt_button " ~ types[index|int] ~ "|_SWAP_CHANNEL_DIALOG CHANNEL=" ~ (index+1)|string ~ "|primary|" ~ colors[index|int] %}
      RESPOND TYPE=command MSG="{temp}"
    {% endif %}    
  {% endfor %}
  RESPOND TYPE=command MSG="action:prompt_button_group_end"

  #Backups - display and save available to mark used when spent
  #backup_filament_spent:[0,0,0,0] # mark as 1 when index not used in backup, all ones when backup disabled
  {% if ifs_backup == 1 %}
    {% set fs = namespace(temp_backup_filament_spent=[]) %}
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    {% for index in range(0,4) %}
      {% set ns = namespace(duplicates=0) %}
      {% for index2 in range(0,4) %}
        #check if there are duplicate colors and types and loaded
        {% if colors[index] == colors[index2] and types[index] == types[index2] and index != index2 %}
          {% if printer['filament_switch_sensor _ifs_port_sensor_'+(index+1)|string].filament_detected %}
            {% if printer['filament_switch_sensor _ifs_port_sensor_'+(index2+1)|string].filament_detected %}
              {% set ns.duplicates= 1 %}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {% if ns.duplicates == 0 %}
        {% set temp = "action:prompt_button ----" %}
        RESPOND TYPE=command MSG="{temp}"
        {% set _ = fs.temp_backup_filament_spent.append(1) %} #{% set _ = ns.e_feedrates.append(130) %}
      {% else %}
        {% set temp = "action:prompt_button 关联|||" ~ colors[index|int] %}
        RESPOND TYPE=command MSG="{temp}"
        {% set _ = fs.temp_backup_filament_spent.append(0) %}
      {% endif %}
    {% endfor %}
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
  {% else %}
    {% set fs = namespace(temp_backup_filament_spent=[1,1,1,1]) %}
  {% endif %}
  SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=backup_filament_spent VALUE="{fs.temp_backup_filament_spent}"

  #Filament status
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  {% for index in range(1,5) %}
    {% if printer['filament_switch_sensor _ifs_port_sensor_'+index|string].filament_detected %}
      RESPOND TYPE=command MSG="action:prompt_button IFS{index}|||509F00"
    {% else %}
      RESPOND TYPE=command MSG="action:prompt_button IFS{index}|||FF0000"
    {% endif %}
  {% endfor %}
  RESPOND TYPE=command MSG="action:prompt_button_group_end"

  #check that filament is ready
  {% set ns = namespace(filament_ready = 1) %}
  {% for tool in tools %}
    {% if not printer['filament_switch_sensor _ifs_port_sensor_'+ifs.tools[tool|int]|string].filament_detected %}
      {% set ns.filament_ready = 0 %}
    {% endif %}
  {% endfor %}
  {% set filament_ready = ns.filament_ready %}

  {% set ns = namespace(valid_version = 1)  %}
  {% set version = ifs.min_version.split('.') %}
  {% if tools | length > 1 %}
    {% if (version_colors[0]|int, version_colors[1]|int, version_colors[2]|int) < (version[0]|int, version[1]|int, version[2]|int) %}
      RESPOND TYPE=command MSG="action:prompt_text 更新“灯丝更改 gcode”"
      RESPOND PREFIX="info" MSG="将“灯丝更改 gcode”更新为 https://github.com/Hrybmo/lessWaste/blob/master/OrcaSlicer_GCODE.md"
      {% set ns.valid_version = 0  %}
    {% endif %}
  {% endif %}
  {% set valid_version = ns.valid_version %}

  {% if start == 1 %}
    RESPOND TYPE=command MSG="action:prompt_footer_button 取消|_IFS_COLORS_CANCEL"
    {% if valid_version == 1 and filament_ready == 1 %}
      RESPOND TYPE=command MSG="action:prompt_footer_button 打印|_IFS_COLORS_PRINT|primary"
    {% elif valid_version == 0 %}
      RESPOND TYPE=command MSG="action:prompt_footer_button 打印|_IFS_COLORS_NOTIFICATION TITLE='Error' MSG='更新灯丝将 gcode 更改为 https://github.com/Hrybmo/lessWaste/blob/master/OrcaSlicer_GCODE.md'|error"
    {% else %}
      RESPOND TYPE=command MSG="action:prompt_footer_button 打印|_IFS_COLORS_NOTIFICATION TITLE='Error' MSG='在加载所有耗材之前，无法进行打印。'|error"
    {% endif %}
  {% else %}
    RESPOND TYPE=command MSG="action:prompt_footer_button 取消|_IFS_COLORS_CANCEL"
  {% endif %}
  RESPOND TYPE=command MSG="action:prompt_show"
  SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=open VALUE=1

[gcode_macro _SWAP_CHANNEL_DIALOG]
gcode:
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  {% set channel_in = params.CHANNEL|int %}
  {% set tools = ifs.tools %}
  {% set types = ifs.types %}
  {% set colors = ifs.colors %}

  RESPOND TYPE=command MSG="action:prompt_begin 选择要交换的 IFS 通道"
  {% set temp = "action:prompt_button IFS" ~ channel_in ~ ":" ~ types[(channel_in-1)|int] ~ "||primary|" ~ colors[(channel_in-1)|int] %}
  RESPOND TYPE=command MSG="{temp}"
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  {% for port in range(1,5) %}
    {% set temp = "action:prompt_button IFS " ~ port ~ "|_SWAP_CHANNEL IN=" ~ channel_in ~ " OUT=" ~ port %}
    RESPOND TYPE=command MSG="{temp}"
  {% endfor %}
  RESPOND TYPE=command MSG="action:prompt_button_group_end"
  RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|_IFS_COLORS"
  RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _SWAP_CHANNEL] #swap colors, tools, and types
gcode:
  {% set current_channel = params.IN|int %}
  {% set new_channel = params.OUT|int %}
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  {% set ns = namespace(new_tools=[], new_types=[], new_colors=[]) %}
  
  {% for index in range(0,4) %}
    {% if (index+1) == current_channel %}
      {% set _ = ns.new_tools.append(ifs.tools[(new_channel-1)]) %}
      {% set _ = ns.new_types.append(ifs.types[(new_channel-1)]) %}
      {% set _ = ns.new_colors.append(ifs.colors[(new_channel-1)]) %}
    {% elif (index+1) == new_channel %}
      {% set _ = ns.new_tools.append(ifs.tools[(current_channel-1)]) %}
      {% set _ = ns.new_types.append(ifs.types[(current_channel-1)]) %}
      {% set _ = ns.new_colors.append(ifs.colors[(current_channel-1)]) %}
    {% else %}
      {% set _ = ns.new_tools.append(ifs.tools[index]) %}
      {% set _ = ns.new_types.append(ifs.types[index]) %}
      {% set _ = ns.new_colors.append(ifs.colors[index]) %}
    {% endif %}
  {% endfor %}
  SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=tools VALUE='{ns.new_tools}'
  SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=types VALUE="['{ns.new_types[0]}','{ns.new_types[1]}','{ns.new_types[2]}','{ns.new_types[3]}']"
  SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=types VALUE='"{ns.new_types|join(",")}"'
  SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=colors VALUE="['{ns.new_colors[0]}','{ns.new_colors[1]}','{ns.new_colors[2]}','{ns.new_colors[3]}']"
  SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=colors VALUE='"{ns.new_colors|join(",")}"'
  SAVE_VARIABLE VARIABLE=less_waste_tools VALUE='{ns.new_tools}'
  SAVE_VARIABLE VARIABLE=less_waste_types VALUE="['{ns.new_types[0]}','{ns.new_types[1]}','{ns.new_types[2]}','{ns.new_types[3]}']"
  SAVE_VARIABLE VARIABLE=less_waste_colors VALUE="['{ns.new_colors[0]}','{ns.new_colors[1]}','{ns.new_colors[2]}','{ns.new_colors[3]}']"
  #G4 P150 # small delay for variable update
  _IFS_COLORS

[gcode_macro _IFS_VARS]
#  "_IFS_VARS filament_load_speed=?" print the current filament load speed
#  "_IFS_VARS filament_load_speed=600" change the load speed to 600 for the following filament changes

variable_filament_unload_before_cutting:24
#for 24mm retraction before cut, 35mm are needed to fill the hotend without material oozing out
variable_filament_drop_length:  35
variable_filament_unload_after_cutting:2
variable_filament_unload_speed:1500
variable_nozzle_cleaning_length:70 # default setting is 70
variable_filament_load_speed: 900
variable_filament_home_speed: 700
variable_filament_insert_speed: 2800
variable_filament_tube_length: 1000
variable_filament_catch_length: 5
variable_filament_pressure_length: 1
variable_filament_autoinsert_full_length: 550
variable_tools:[1,2,3,4] # index is the tool, value is the IFS port
variable_external:0
variable_extruder_port: -1 
variable_current_tool: -1
variable_extruder_temp: 0
variable_extruder_fan: 0
variable_bed_temp: 0 # for zrestore
variable_e_feedrate: 130
variable_e_feedrates:[]
variable_consume: 0
variable_kamp: 0
variable_line_purge: 0
variable_backup: 0
variable_types:['PLA','PLA','PLA','PLA']
variable_colors:['000000','000000','000000','000000']
variable_backup_filament_spent:[0,0,0,0] # mark as 1 when index not used in backup, all ones when backup disabled
variable_start:0
variable_sbros_trash_speed:4000
variable_info_dialog:1
variable_min_version:'1.2.3'
variable_last_type:['NA']
variable_last_color:['NA']
variable_same_filament_purge:1

gcode:
    {% for variable, value in params.items() %}
      {% if value == '?' %}
        RESPOND PREFIX="info" MSG="{variable|lower|replace('_', ' ')|title} : {printer['gcode_macro _IFS_VARS'][variable|lower]}"
      {% else %}
        SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE={variable|lower} VALUE="{value}"
        SAVE_VARIABLE VARIABLE=less_waste_{variable|lower} VALUE="{value}"
        _IFS_VARS_INFO VARIABLE={variable|lower}
        {% if variable=="KAMP" %}
          LOAD_GCODE_OFFSET
        {% endif %}
      {% endif %}
    {% endfor %}

[gcode_macro _IFS_VARS_INFO]
gcode:
  RESPOND PREFIX="info" MSG="{params.VARIABLE|lower|replace('_', ' ')|title} : {printer['gcode_macro _IFS_VARS'][params.VARIABLE|lower]}"

[gcode_macro _DISPLAY_OFF]
gcode:
  {% set guppy = params.GUPPY|default(1)|int %}
  RESPOND TYPE=command MSG="action:prompt_end"
  SAVE_VARIABLE VARIABLE=display_off VALUE=1
  RUN_SHELL_COMMAND CMD=zdisplay PARAMS="guppy"
  SAVE_VARIABLE VARIABLE=guppy VALUE={1|int}
  RESTART

[delayed_gcode _START_lessWaste]
initial_duration:4 #10 or less seems to work
gcode:
  RESPOND PREFIX="info" MSG="_START_减少浪费..."
  {% if printer.save_variables.variables.less_waste_reinstall is defined %}
    {% set reinstall = printer.save_variables.variables.less_waste_reinstall %}
  {% else %}
    {% set reinstall = 1 %}
  {% endif %}
  {% if reinstall == 1 %}
    RESPOND PREFIX="info" MSG="重新安装减少浪费..."
    SAVE_VARIABLE VARIABLE=less_waste_reinstall VALUE=0
    ENABLE_PLUGIN name=lessWaste
  {% else %}
    {% set screen = printer["gcode_macro _SCREEN"].screen %}
    {% if screen == True %}
      RESPOND TYPE=command MSG="action:prompt_begin Warning"
      RESPOND TYPE=command MSG="action:prompt_text LessWaste 不适用于本机屏幕，它需要 (DISPLAY_OFF)"
      RESPOND TYPE=command MSG="action:prompt_footer_button 启用 DISPLAY_OFF|_DISPLAY_OFF|info"
      RESPOND TYPE=command MSG="action:prompt_footer_button 禁用减少浪费|DISABLE_PLUGIN name=lessWaste|info"
      RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
      {% for var in printer['gcode_macro _IFS_VARS'] if printer.save_variables.variables['less_waste_'+var] is defined %}
        {% if not var|lower in ['config', 'settings'] %}
          RESPOND PREFIX="info" MSG="{var}: {printer.save_variables.variables['less_waste_'+var]}"
          SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE={var} VALUE="{printer.save_variables.variables['less_waste_'+var]}"
        {% endif %}
      {% endfor %}
      SDCARD_ENABLE_FFM ENABLE=0
      LOAD_GCODE_OFFSET
      ZRESTORE TEST=1
      RESPOND PREFIX="info" MSG="_START_less浪费已完成。"
    {% endif %}
  {% endif %}


[delayed_gcode _ONESHOT_START]
initial_duration:1
gcode:
  {% set display_off_timeout = printer.save_variables.variables.display_off_timeout|default(20) | int %}
  UPDATE_DELAYED_GCODE ID=_UNLOCK_IFS DURATION={display_off_timeout}

[delayed_gcode _UNLOCK_IFS] # IFS fix coming from stock screen
initial_duration:0
gcode:
  {% set screen = printer["gcode_macro _SCREEN"].screen %}
  {% if screen == False %}
    IFS_F18 # unlock all
    #IFS_F15 # reset driver
  {% endif %}

#Tools gcode commands
[gcode_macro T0]
gcode:
    _T TOOL=0

[gcode_macro T1]
gcode:
    _T TOOL=1

[gcode_macro T2]
gcode:
    _T TOOL=2

[gcode_macro T3]
gcode:
    _T TOOL=3

[gcode_macro T4]
gcode:
    _T TOOL=4

[gcode_macro T5]
gcode:
    _T TOOL=5

[gcode_macro T6]
gcode:
    _T TOOL=6

[gcode_macro T7]
gcode:
    _T TOOL=7

[gcode_macro T8]
gcode:
    _T TOOL=8

[gcode_macro T9]
gcode:
    _T TOOL=9

[gcode_macro T10]
gcode:
    _T TOOL=10

[gcode_macro T11]
gcode:
    _T TOOL=11

[gcode_macro T12]
gcode:
    _T TOOL=12

[gcode_macro T13]
gcode:
    _T TOOL=13

[gcode_macro T14]
gcode:
    _T TOOL=14

[gcode_macro T15]
gcode:
    _T TOOL=15

[gcode_macro _NOPOOP]
variable_nopoop:0
variable_x:0
variable_y:0
variable_z:0
gcode:
    SET_GCODE_VARIABLE MACRO=_NOPOOP VARIABLE=nopoop VALUE=1
    SET_GCODE_VARIABLE MACRO=_NOPOOP VARIABLE=x VALUE={printer.gcode_move.gcode_position.x}
    SET_GCODE_VARIABLE MACRO=_NOPOOP VARIABLE=y VALUE={printer.gcode_move.gcode_position.y}
    SET_GCODE_VARIABLE MACRO=_NOPOOP VARIABLE=z VALUE={printer.gcode_move.gcode_position.z}

[gcode_macro _T]
#  Checks to be performed before the actual tool/filament change.
gcode:
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}
    {% if ifs.external == 0 %}
      {% set tool = params.TOOL|default(0)|int %}
      _IFS_VARS current_tool={tool}
      {% set temp_type = ifs.types[tool] %}
      {% set temp_color = ifs.colors[tool] %}
      {% set extruder_port = ifs.extruder_port %}
      {% set port = ifs.tools[tool] %}
      {% if extruder_port > 0 and not printer['filament_switch_sensor head_switch_sensor'].filament_detected %}
          {% set extruder_port = 0 %}
          _IFS_VARS extruder_port=0
      {% endif %}
      {% if port > 0 %}
          RESPOND PREFIX="info" MSG="加载灯丝 {port}"
          {% if extruder_port == -1 %}
              _CHECK_FILAMENT
          {% endif %}
          # if there is a filament in the IFS (port)
          {% if printer['filament_switch_sensor _ifs_port_sensor_'+port|string].filament_detected %}
            _IFS_VARS last_type="['{temp_type}']"
            _IFS_VARS last_color="['{temp_color}']"
            M400 # wait for moves to finish
            _DISABLE_SENSORS
            _INSERT_PORT_IFS PORT={port}
            _ENABLE_SENSORS
          {% else %}
            PAUSE REASON="empty"
          {% endif %}
      {% endif %}
      # slicer set the temp for new filament [new_filament_temp].
      _IFS_VARS extruder_temp={(printer.extruder.target or 255)|int}
      _IFS_VARS e_feedrate={ifs.e_feedrates[tool]|int}
    {% endif %}

# load/unload filaments from IFS, redefined zmod macros.
# poop/temperatures/materials are managed by bambu studio (or Orca) Change filament G-code
# see MACHINE_GCODE.md

[gcode_macro _INSERT_PORT_IFS]
description: 
gcode:
  {% set port = params.PORT|default(1)|int %}
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  {% set extruder_port = ifs.extruder_port %}
  
  # if it is a different port than the extruder one
  {% if extruder_port != port %}
    _CONSUME #check if we need to extrude the leftover filament because run out in the IFS

    {% set filament_load_speed    = params.FILAMENT_LOAD_SPEED|default(ifs.filament_load_speed)|int %}
    {% set filament_home_speed    = params.FILAMENT_HOME_SPEED|default(ifs.filament_home_speed)|int %}
    {% set filament_tube_length   = params.FILAMENT_TUBE_LENGTH|default(ifs.filament_tube_length)|int %}
    {% set filament_drop_length   = params.FILAMENT_DROP_LENGTH|default(ifs.filament_drop_length)|int %}
    {% set filament_catch_length   = params.FILAMENT_CATCH_LENGTH|default(ifs.filament_catch_length)|int %}
    {% set filament_pressure_length   = params.FILAMENT_PRESSURE_LENGTH|default(ifs.filament_pressure_length)|int %}
    {% set extruder_temp          = (printer.extruder.target or printer['gcode_macro _IFS_VARS'].extruder_temp or 255)|int %}

    _IFS_VARS extruder_fan={printer["fan_generic fanM106"].speed or 0.8}
    M106 S0
    
    _G28
    {% if not printer.print_stats.state == "printing" %}
        _GOTO_TRASH
    {% endif %}

    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+4}
    
    #UNLOAD (CUT and PULL back from IFS)
    _IFS_UNLOAD

    {% if printer['gcode_macro _NOPOOP'].nopoop == 0 %}
      _GOTO_TRASH # If we are printing and did not need to cut, then now we will go to TRASH
    {% endif %}
    
    #LOAD
    IFS_F24 PRUTOK={port}
    IFS_F10 PRUTOK={port} LEN={filament_tube_length} SPEED={filament_home_speed} CHECK=1 # Homering the filament requires a safe and fixed speed
    
    G92 E0

    # 1/3 of filament_drop_length for the extruder catch the filament
    IFS_F10 PRUTOK={port} LEN={filament_pressure_length} SPEED={filament_load_speed}  #pressure
    G1 E{filament_drop_length} F{(filament_load_speed)|int}
    IFS_F10 PRUTOK={port} LEN={(filament_drop_length)|int} SPEED={filament_load_speed} SLEEP=1
    IFS_F39 PRUTOK={port}
    IFS_F23 PRUTOK={port} #this set chan = port in the IFS
    SET_EXTRUDER_SLOT SLOT={port} #this set_cur_port(zmod_ifs.py) so ifs_motion_sensor read the current port

    _CHECK_MOTION PORT={port}

    G92 E0
    
  {% endif %}

[gcode_macro _REZGEM_PRUTOK]
description: Cut the filament
variable_x_cut: -2.5
variable_y_cut: -7.5
gcode:
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}
    {% set filament_unload_before_cutting  = params.FILAMENT_UNLOAD_BEFORE_CUTTING|default(ifs.filament_unload_before_cutting)|int %}
    {% set filament_unload_after_cutting   = params.FILAMENT_UNLOAD_AFTER_CUTTING|default(ifs.filament_unload_after_cutting)|int %}
    {% set filament_unload_speed           = params.FILAMENT_UNLOAD_SPEED|default(ifs.filament_unload_speed)|int %}

    RESPOND PREFIX="info" MSG="切割灯丝"
    RESPOND PREFIX="info" MSG="切 X={x_cut} Y={y_cut}"
    {% if printer.toolhead.position.x < 20 %}
        G1 X20 F600
    {% endif %}
    
    G92 E0
    {% if printer.toolhead.position.y > 220.00 %}
        G1 Y220 F{ifs.sbros_trash_speed} #slow exit trash, be quiet
    {% endif %}
    # move to cut position and retract at the same time
    G1 Y10 E-{filament_unload_before_cutting/3} F12000
    G1 Y{y_cut} E-{filament_unload_before_cutting/3} F1800
    G1 X20 E-{filament_unload_before_cutting/3} F12000 #fast to X20
    G1 X{x_cut} F600 #Cut slow
    G92 E0
    G1 E-{filament_unload_after_cutting} F{filament_unload_speed}
    G92 E0
    G1 F12000 #fast again

[gcode_macro _IFS_UNLOAD]
gcode:
    {% set cut = params.CUT|default(1)|int %}
    {% set release = params.RELEASE|default(0)|int %}
    
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}
    {% set extruder_port = params.PORT|default(ifs.extruder_port)|int %}
    {% if extruder_port > 0 %}
      {% set filament_unload_speed           = params.FILAMENT_UNLOAD_SPEED|default(ifs.filament_unload_speed)|int %}
      {% set nozzle_cleaning_length          = params.NOZZLE_CLEANING_LENGTH|default(ifs.nozzle_cleaning_length)|int %}

      {% if cut == 1 %}
        _REZGEM_PRUTOK FILAMENT_UNLOAD_SPEED={filament_unload_speed}
        {% set _NOPOOP = printer['gcode_macro _NOPOOP'] %}
        {% if _NOPOOP.nopoop == 0 %}
          _GOTO_TRASH
        {% else %}
          SET_GCODE_VARIABLE MACRO=_NOPOOP VARIABLE=nopoop VALUE=0
          G1 X20 F12000
          {% if _NOPOOP.x > 0 %}
            G1 X{_NOPOOP.x}
            G1 Y{_NOPOOP.y}
            G1 Z{_NOPOOP.z}
          {% endif %}
        {% endif %}
      {% endif %}
      
      G92 E0
  
      RESPOND PREFIX="info" MSG="卸料丝 {extruder_port}"
      IFS_F24 PRUTOK={extruder_port}
      G1 E-{nozzle_cleaning_length} F{filament_unload_speed}
      IFS_F11 PRUTOK={extruder_port} LEN={nozzle_cleaning_length} SPEED={filament_unload_speed}
      _IFS_VARS extruder_port=0
      {% if release== 1 %}
        IFS_F39 PRUTOK={extruder_port}
      {% endif %}
      
    {% endif %}


# Check the filament movement when _INSERT_PORT_IFS to ensure everything is OK before continuing with printing/pooping from the slicer

[gcode_macro _CHECK_MOTION]
gcode:
    M400
    {% set port = params.PORT|default(1)|int %}
    
    {% if not printer['filament_motion_sensor _ifs_motion_sensor_'+port|string].filament_detected %}
      _IFS_UNLOAD CUT=0 PORT={port} RELEASE=1
      PAUSE REASON="loading"
    {% else %}
      _IFS_VARS extruder_port={port}
      IFS_MOTION_ON # force ifs motion sensor to true
      IFS_SWITCH_ON # force ifs presence sensor to true
    {% endif %}


# disable timeout when printing

[idle_timeout]
  timeout = 300 #5 Minutes
gcode:
  {% if printer.pause_resume.is_paused %}
    RESPOND PREFIX="info" MSG="超时被忽略，因为打印机状态 == 已暂停。"
    M104 S0 # Cool only the hotend after a 5-minute pause
  {% else %}
    M84
    TURN_OFF_HEATERS
    M107
   {% endif %}


# macros for start, stop, pause and end printing

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
    _IFS_VARS current_tool=-1
    {% if printer.print_stats.state=="paused" or printer.print_stats.state == "printing" %}
        END_PRINT
    {% endif %}
    CANCEL_PRINT_BASE
    ZRESTORE TEST=2

[gcode_macro END_PRINT]
description: End G-code
gcode:
    {% set consume = printer['gcode_macro _IFS_VARS'].consume %}
    #first check if printing and if so, move off the part
    {% if "xyz" in printer.toolhead.homed_axes %}
      M140 S0 ;Turn-off bed 

      G91 ;Relative positioning
      G1 F1800 E-2 ; Retract filament 2 mm to prevent oozing
      G1 F3000 Z.6 ; Move Z Axis up .6 mm
      G90
      M83
      {% if consume > 0 %}
        _GOTO_TRASH
        M107 ; turn off fan
        _CONSUME
        _DISABLE_SENSORS
        _IFS_UNLOAD CUT=0 RELEASE=1
      {% else %}
        _DISABLE_SENSORS
        _IFS_UNLOAD RELEASE=1
        M107 ; turn off fan
        _GOTO_TRASH
      {% endif %}
      {% set z = printer.gcode_move.gcode_position[2] | float %}
      {% set z_max = printer.toolhead.axis_maximum.z %}
      {% set z_proposed = z + 100 %}
      {% set z_target = z_max if z_proposed > z_max else z_proposed %}
      G1 Z{z_target} F600
    {% endif %}             

    _IFS_VARS current_tool=-1
    M104 S0 ;Turn-off hotend
    M84     ; turn off steppers
    M117
    ZRESTORE TEST=2

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
  {% if printer.print_stats.state == "printing" %}
    M106 S0
    {% set reason = params.REASON|default('user') %}
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}

    {% if "xyz" in printer.toolhead.homed_axes %}
      {% set z_max = 220 %}
      {% set pos_act = printer.gcode_move.gcode_position %} #absolute position
      {% if pos_act.z < (z_max - 2) %}
        {% set z_safe = pos_act.z + 2 %}
      {% else %}
        {% set z_safe = z_max %}
      {% endif %}
    {% endif %}
    # extruder temp is store after each filament change (see _T command)
    # extruder temp go to 0 after 5 minutes paused (see [idle_timeout] section)
    _IFS_VARS extruder_temp={(printer.extruder.target or ifs.extruder_temp or 255)|int}
    _IFS_VARS extruder_fan={printer["fan_generic fanM106"].speed or 0.8}
    #{% if reason != 'backup' %}
    PAUSE_BASE 
    #{% endif %}
    _DISABLE_SENSORS
    {% if ifs.start == 0 %}
      {% if reason != 'loading' %}
          # We are printing so we park
          {% if "xyz" in printer.toolhead.homed_axes %}
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=x_act VALUE={pos_act.x}
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=y_act VALUE={pos_act.y}
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=z_act VALUE={pos_act.z}
            G1 E-2 F300
            G92 E0
            G1 Z{z_safe} F900 #absolute position
            _GOTO_TRASH
          {% endif %}
          {% if reason != 'backup' %}
            RESPOND PREFIX="info" MSG="打印期间暂停"
          {% endif %}
      {% else %}
          # We are loading and we PAUSE then we are already in trash position, we dont need parking
          SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=x_act VALUE=0
          SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=y_act VALUE=0
          SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=z_act VALUE=0
          {% if reason != 'backup' %}
            RESPOND PREFIX="info" MSG="加载期间暂停"
          {% endif %}
      {% endif %}
      {% set tip = "如果发生堵塞，请检查细丝线轴或类似物中是否有结。如果灯丝用完，请在同一端口加载新灯丝，直至硬停止。准备好继续时按“恢复打印”"%}
      {% if reason == 'loading' %}
        _INFO_DIALOG TITLE="Pause" MSG="检测到加载灯丝堵塞 ({ifs.extruder_port|string}), 暂停..." TIP="{tip}" CLOSE=1
        RESPOND PREFIX="info" MSG="检测到加载灯丝堵塞 ({ifs.extruder_port|string}), 暂停..."
      {% elif reason == 'jam' %}
        _INFO_DIALOG TITLE="Pause" MSG="检测到卡纸（运动） ({ifs.extruder_port|string}), 暂停..." TIP="{tip}" CLOSE=1
        RESPOND PREFIX="info" MSG="检测到卡纸（运动） ({ifs.extruder_port|string}), 暂停..."
      {% elif reason == 'nobackup' %}
        _INFO_DIALOG TITLE="Pause" MSG="用完灯丝（头） ({ifs.extruder_port|string}), 尚未找到备份替代方案，暂停..." CLOSE=1
        RESPOND PREFIX="info" MSG="用完灯丝（头） ({ifs.extruder_port|string}), 尚未找到备份替代方案，暂停..."
      {% elif reason == 'runout' %}
        _INFO_DIALOG TITLE="Pause" MSG="用完灯丝（头） ({ifs.extruder_port|string}), 暂停..." TIP="{tip}" CLOSE=1
        RESPOND PREFIX="info" MSG="用完灯丝（头） ({ifs.extruder_port|string}), 暂停..."
      {% elif reason == 'broken' %}
        _INFO_DIALOG TITLE="Pause" MSG="IFS 管（头）灯丝断裂 ({ifs.extruder_port|string}), 暂停..." TIP="{tip}" CLOSE=1
        RESPOND PREFIX="info" MSG="IFS 管（头）灯丝断裂 ({ifs.extruder_port|string}), 暂停..."
      {% elif reason == 'empty' %}
        _INFO_DIALOG TITLE="Pause" MSG="IFS端口 ({ifs.extruder_port|string}) 空，请插入灯丝，暂停..." TIP="{tip}" CLOSE=1
        RESPOND PREFIX="info" MSG="IFS端口 ({ifs.extruder_port|string}) 空，请插入灯丝，暂停..."
      {% endif %}
      {% if reason != 'backup' and reason != "user" %}
        PLAY_MIDI FILE=Attention.mid
      {% endif %}
    {% endif %}
    {% if printer.extruder.temperature > 170 and ifs.start == 0 and not printer['filament_switch_sensor head_switch_sensor'].filament_detected %}
      M400 #try to mitigate timer too close
      G1 E20 F130 # Extrude any remaining filament that may be left between the sensor head and the extruder wheels
      G92 E0
    {% endif %}
    {% if reason == 'backup' %}
      M400 #try to mitigate timer too close
      G1 E5 F130 # Build a bit more pressure
      G92 E0
      RESUME FORCE=1
    {% endif %}
  {% endif %}

[gcode_macro RESUME]
variable_x_act:0
variable_y_act:0
variable_z_act:0
rename_existing: RESUME_BASE
gcode:
  {% set force = params.FORCE|default(0)|int %}
  {% if force or printer.print_stats.state == "paused" %}
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}
    
    # restore extruder temp
    {% if ifs.extruder_temp > 0 %}
      M104 S{ifs.extruder_temp}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={ifs.extruder_temp-2} MAXIMUM={ifs.extruder_temp+4}
    {% endif %}
    _ENABLE_SENSORS
    {% if ifs.current_tool >= 0 %}
        RESPOND PREFIX="info" MSG="RESUME 中的预换工具"
        T{ifs.current_tool}
        RESPOND PREFIX="info" MSG="RESUME 中的工具更换后"
        POOP FLUSH_LENGTH=45
    {% endif %}
    
    {% set z_act = printer['gcode_macro RESUME'].z_act %}
    {% if z_act > 0 %}
        {% set x_act = printer['gcode_macro RESUME'].x_act %}
        {% set y_act = printer['gcode_macro RESUME'].y_act %}
        # We restore X and Y first, then Z, to avoid collisions
        {% if printer.toolhead.position.y > 220.00 %}
            G1 Y220 F{ifs.sbros_trash_speed}
        {% endif %}
        G1 X{x_act} Y{y_act} F3000
        G1 Z{z_act} F300 
    {% endif %}
    #restore fan
    #M106 S{ifs.extruder_fan}
    SET_FAN_SPEED FAN=fanM106 SPEED={ifs.extruder_fan} # 1 is max speed
    RESPOND PREFIX="info" MSG="预RESUME_BASE"
    RESUME_BASE # this will restore XYZ but we have already done so
    
  {% endif %}

[gcode_macro POOP]
gcode:
  {% set extruder_temp = (printer.extruder.target or printer['gcode_macro _IFS_VARS'].extruder_temp or 255)|int %}
  {% set flush_length = params.FLUSH_LENGTH|default(75)|int %}
  {% set e_feedrate = params.E_FEEDRATE|default(130)|int %}

  _G28
  RESPOND PREFIX="info" MSG="将喷嘴加热至 {extruder_temp} 度"
  M104 S{extruder_temp}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2}
  _GOTO_TRASH
  G92 E0
  G1 E{flush_length-10} F{e_feedrate}
  G92 E0
  M106 S102
  G1 E10 F{e_feedrate}
  G92 E0
  G1 E-2 F300
  G92 E0
  M106 S0
  _SBROS_TRASH

[gcode_macro _INFO_DIALOG]
gcode:
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  {% set title = params.TITLE | default('title') %}
  {% set msg = params.MSG | default('message') %}
  {% set info_dialog = ifs.info_dialog|default(1) %}
  {% set close = params.CLOSE|default(0) %}
  {% set tip = params.TIP|default(0) %}

  RESPOND PREFIX="info" MSG="lessWaste - {title}: {msg}"
  {% if info_dialog == 1 %}
    RESPOND TYPE=command MSG="action:prompt_begin lessWaste - {title}"
    RESPOND TYPE=command MSG="action:prompt_text {msg}"
    {% if tip %}
      RESPOND TYPE=command MSG="action:prompt_text {tip}"
    {% endif %}
    RESPOND TYPE=command MSG="action:prompt_footer_button 隐藏未来消息|_INFO_DIALOG_HIDE"
    {% if close|int == 1 %}
      RESPOND TYPE=command MSG="action:prompt_footer_button 关闭|_INFO_DIALOG_CLOSE|primary"
    {% endif %}
      RESPOND TYPE=command MSG="action:prompt_show"
  {% endif %}

[gcode_macro _INFO_DIALOG_CLOSE]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro _INFO_DIALOG_SHOW]
gcode:
  _IFS_VARS info_dialog=1
  RESPOND PREFIX="info" MSG="将显示信息对话框"

[gcode_macro _INFO_DIALOG_HIDE]
gcode:
  _IFS_VARS info_dialog=0
  RESPOND PREFIX="info" MSG="信息对话框已隐藏"
  {% if printer['gcode_macro _IFS_COLORS'].open == 1 %}
    _IFS_COLORS
  {% else %}
     RESPOND TYPE=command MSG="action:prompt_end"
  {% endif %}

[gcode_macro START_PRINT]
gcode:
  M400 #try to mitigate timer too close
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  {% set extruder_temp = params.EXTRUDER_TEMP | default(255) | int %}
  {% set old_extruder_temp = (printer['gcode_macro _IFS_VARS'].extruder_temp)|int %}
  {% if old_extruder_temp > extruder_temp %}
    {% set extruder_temp =  old_extruder_temp %}
  {% endif %}
  _DISABLE_SENSORS
  {% set bed_temp = params.BED_TEMP | default(70)|int %}
  _IFS_VARS bed_temp={bed_temp}
  {% set tool = params.TOOL | default(0) | int %}
  CLEAR_PAUSE
  RESPOND PREFIX="info" MSG="预印本行动..."
  M104 S160 #warm hotend below oozing temp
  M140 S{bed_temp}
  _G28
  M400 #try to mitigate timer too close
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp-30} MAXIMUM={bed_temp+6}
  RESPOND PREFIX="info" MSG="开始打印 {extruder_temp}/{bed_temp} ..."
  M104 S{extruder_temp}
  G90
  M204 S9000
  _GOTO_TRASH
  G0 Z20 F1500
  #ZCONTROL_ABORT
  #ZCONTROL_ON
  #ZSSH_RELOAD
  _IFS_VARS extruder_port=-1
  _IFS_VARS consume=0
  SET_GCODE_VARIABLE MACRO=_NOPOOP VARIABLE=nopoop VALUE=0
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2}
  {% set extruder_temp = params.EXTRUDER_TEMP | default(255) | int %}
  _IFS_VARS extruder_temp={extruder_temp|int}
  SDCARD_ENABLE_FFM ENABLE=0
  LOAD_GCODE_OFFSET
  {% set ns = namespace(is_poop = 1) %}
  {% if tool >= 0 %}
    # Check if the same filament is in the extruder
    {% if ifs.last_type[0] == ifs.types[tool] and ifs.last_color[0] == ifs.colors[tool] %}
      {% if ifs.same_filament_purge == 0 %}
        {% set ns.is_poop = 0 %}
        RESPOND PREFIX="info" MSG="检测到相同的灯丝，跳过相同的清除。要在将来清除相同的内容，请输入 _IFS_VARS same_filament_purge=1"
      {% else %}
        RESPOND PREFIX="info" MSG="检测到相同的灯丝，要在将来跳过相同的清除，请键入 _IFS_VARS same_filament_purge=0"
      {% endif %}
    {% endif %}
    # enable the tool and set last filament
    T{tool}
  {% endif %}
  {% if ns.is_poop == 1 %}
    POOP
  {% else %}
    _SBROS_TRASH
  {% endif %}
  M204 S9000
  _CLEAR_REZINA
  M104 S{extruder_temp}
  {% if ifs.kamp == 1 %}
    BED_MESH_CLEAR
    _CLEAR_NOZZLE
    LOAD_CELL_TARE
    _KAMP_BED_MESH_CALIBRATE
  {% else %}
    BED_MESH_PROFILE LOAD="auto"
  {% endif %}
  M104 S{extruder_temp}
  _SMART_PARK
  M400 #try to mitigate timer too close
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2}
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp-2} MAXIMUM={bed_temp+4}
  SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=1
  {% if ifs.external ==  0 %}
    SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=1
  {% endif %}
  {% if ifs.line_purge == 1 %}
    LINE_PURGE #compensates for different nozzle sizes
    M400 #try to mitigate timer too close
  {% endif %}
  M204 S1000
  SET_GCODE_VARIABLE MACRO=_IFS_VARS VARIABLE=start VALUE=0
    
#  more redefining zmod macros

[gcode_macro SET_GCODE_OFFSET]
description: Save Z-Offset
rename_existing: _SET_GCODE_OFFSET
gcode:
  {% set start = params.START|default(0)|int %}

  {% if start == 0 %}
    {% set ifs = printer["gcode_macro _IFS_VARS"] %}
    {% set offsets = {'z': None} %}
    {% if ifs.kamp == 1 %}
      {% if printer.save_variables.variables.kamp_offsets %}
        {% set offsets = printer.save_variables.variables.kamp_offsets %}
      {% endif %}
    {% else %}
      {% if printer.save_variables.variables.gcode_offsets %}
        {% set offsets = printer.save_variables.variables.gcode_offsets %}
      {% endif %}
    {% endif %}

    {% set ns = namespace(offsets={'z': offsets.z}) %}

    {% if 'Z' in params %}
        {% set null = ns.offsets.update({'z': params.Z}) %}
    {% endif %}

    {% if 'Z_ADJUST' in params %}
        {% if ns.offsets.z == None %}
            {% set null = ns.offsets.update({'z': 0}) %}
        {% endif %}
        {% set null = ns.offsets.update({'z': (ns.offsets.z | float) + (params.Z_ADJUST | float)}) %}
    {% endif %}

    _SET_GCODE_OFFSET {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}

    {% if ifs.kamp == 1 %}
      RESPOND PREFIX="info" MSG="Z 偏移 (KAMP)： {ns.offsets.z}"
      SAVE_VARIABLE VARIABLE=kamp_offsets VALUE="{ns.offsets}"
    {% else %}
      RESPOND PREFIX="info" MSG="Z 轴偏移： {ns.offsets.z}"
      SAVE_VARIABLE VARIABLE=gcode_offsets VALUE="{ns.offsets}"
    {% endif %}

  {% endif %}

[gcode_macro LOAD_GCODE_OFFSET]
description: Restore Z-Offset
gcode:
    {% set ifs = printer["gcode_macro _IFS_VARS"] %}

    {% if ifs.kamp == 1 %}
      {% if printer.save_variables.variables.kamp_offsets %}
        {% set offsets = printer.save_variables.variables.kamp_offsets %}
        _SET_GCODE_OFFSET Z={offsets.z}
        RESPOND PREFIX="info" MSG="Z 偏移 (KAMP)： {offsets.z}"
      {% else %}
        SAVE_VARIABLE VARIABLE=kamp_offsets VALUE='{ '{' }"z": "0"{ '}' }'
      {% endif %}
    {% else %}
      {% if printer.save_variables.variables.gcode_offsets %}
        {% set offsets = printer.save_variables.variables.gcode_offsets %}
        _SET_GCODE_OFFSET Z={offsets.z}
        RESPOND PREFIX="info" MSG="Z 轴偏移： {offsets.z}"
      {% endif %}
    {% endif %}

[gcode_macro _GOTO_TRASH]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    # do nothing if it is already in the trash position
    {% if not (printer.toolhead.position.x == client.custom_park_x and printer.toolhead.position.y == client.custom_park_y) %}
        {% set ifs = printer['gcode_macro _IFS_VARS'] %}
        {% set speed = params.SPEED|default(ifs.sbros_trash_speed|default(3000)) %}
        RESPOND PREFIX="info" MSG="去垃圾箱"
        RESPOND PREFIX="info" MSG="垃圾Y={client.custom_park_y}"
        G90
        {% if printer.toolhead.position.x != client.custom_park_x %}
            {% if printer.toolhead.position.y > client.max_y %}
                G1 Y{client.max_y} F{speed}
            {% endif %}
            G1 X{client.custom_park_x} F12000 #Fast
        {% endif %}
        G1 Y{client.max_y} F12000 #fast to client.max_y, no effect if it is already in client.max_y
        G1 Y{client.custom_park_y} F{speed}
        G1 F12000 #Fast again
    {% endif %}

[gcode_macro _SBROS_TRASH]
gcode:
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
  {% set speed = params.SPEED|default(ifs.sbros_trash_speed|default(3000)) %}

  {% if printer.toolhead.position.x == client.custom_park_x %}
    G1 Y223 F{speed}
    G1 Y{client.custom_park_y} F3000
    G1 Y223 F{speed}
    G1 Y{client.custom_park_y} F3000 # We end up in a trash position, so there is an extra swing when go back to printing
    G1 F{speed}
  {% endif %}

[gcode_macro _CLEAR_REZINA]
gcode:
    {% set ifs = printer['gcode_macro _IFS_VARS'] %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set speed = params.SPEED|default(ifs.sbros_trash_speed|default(3000)) %}

    RESPOND PREFIX="info" MSG="清洁橡胶上的喷嘴"

    G1 Y{client.max_y} F{speed*2}
    G1 X65
    G1 Y{client.custom_park_y}
    G1 X80
    G1 X65
    G1 X80 # and stay in the silicone

    G1 F12000 #fast again
    
[gcode_macro _CLEAR_NOZZLE] 
gcode:
    {% set extruder_temp = printer.extruder.target or default(255) %}
    _G28
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}
    _GOTO_TRASH
    G92 E0
    G1 E35 F130
    G92 E0
    M104 S{extruder_temp-75}
    M106 S102
    G1 E10 F130
    G92 E0
    G1 E-2 F300
    G92 E0
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={extruder_temp-25}
    _SBROS_TRASH
    _CLEAR_REZINA
    M106 S{255/100*80}
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={extruder_temp-73}
    M106 S0
    G1 Y220 F3000

[gcode_macro _ZSDCARD_PRINT_FILE]
gcode:
    {% set force_md5 = printer.save_variables.variables.force_md5|default(1) | int %}
    {% if 'FILENAME' in params %}
        {% set filename = params.FILENAME|default("")|string %}
        SET_GCODE_VARIABLE MACRO=_IFS_COLORS VARIABLE=filename VALUE='"{filename}"'
    {% else %}
        {action_raise_error("错误！未指定文件名。")}
    {% endif %}

    {% set path = printer.configfile.settings.virtual_sdcard.path %}
    
    {% if force_md5 == 1 %}
        RESPOND TYPE=command MSG="action:prompt_begin 等待"
        RESPOND TYPE=command MSG="action:prompt_text 检查 MD5 '{filename}' ..."
        RESPOND TYPE=command MSG="action:prompt_show"
        RESPOND PREFIX="info" MSG="开始MD5检查 {filename}"
        CHECK_MD5 FILENAME="{path}{filename}"
    {% endif %}

    _ZSDCARD_PRINT_FILE_CONTINUE PATH='{path}' FILENAME='{filename}'

[gcode_macro _ZSDCARD_PRINT_FILE_CONTINUE]
gcode:
  {% set filename = params.FILENAME|default("")|string %}
  {% set path = params.PATH|default("")|string %}
  {% set check_md5 = printer.save_variables.variables.check_md5|default(0) | int %}
  _IFS_VARS tools="[1,2,3,4]" #reset tools to default here so it functions
  {% if check_md5 == 0 or check_md5 == 3 or check_md5 == 4 or check_md5 == 5 or check_md5 == 8 %}
    RESPOND TYPE=command MSG="action:prompt_begin 等待"
    RESPOND TYPE=command MSG="action:prompt_text 加工 '{filename}'..."
    RESPOND TYPE=command MSG="action:prompt_show"
    {% set filename = path + filename %}
    RUN_SHELL_COMMAND CMD=preprint PARAMS={'"%s"' % (filename.replace("'", "\\\'").replace(" ", "\ "))}
  {% endif %}
    
[gcode_macro _FINAL_STOP_MD5]
gcode:
    {% set check_md5 = printer.save_variables.variables.check_md5|default(0) | int %}
    {% if check_md5 != 3 and check_md5 != 4 and check_md5 != 5 and check_md5 != 8 %}
      RESPOND TYPE=command MSG="action:prompt_begin 错误"
      RESPOND TYPE=command MSG="action:prompt_text MD5检查失败。打印已取消。"
      RESPOND TYPE=command MSG="action:prompt_show"
    {% endif %}

[gcode_shell_command preprint]
command: python3 /opt/config/mod_data/plugins/lessWaste/preprint.py
timeout: 300
verbose: True

[gcode_macro SDCARD_PRINT_FILE]
rename_existing: BASE_SDCARD_PRINT_FILE
gcode:
    BASE_SDCARD_PRINT_FILE {rawparams}

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(255) | float %}
    {% set extrude_len   = params.EXTRUDE_LEN|default(120) |float %}
    {% set speed = params.SPEED|default(300)|float %}

    RESPOND PREFIX="info" MSG="加载灯丝于 {extruder_temp} 为了 {extrude_len}mm 在 {speed/60} mm/s"
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-1}

    SAVE_GCODE_STATE NAME=load_state
    M83
    G92 E0
    _DISABLE_SENSORS
        G1 E{extrude_len/3} F{speed}
        G1 E{extrude_len/3} F{speed}
        G1 E{extrude_len/3} F{speed}
        M400
    _ENABLE_SENSORS
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set extruder_temp = params.EXTRUDER_TEMP|default(255) | float %}
    {% set extrude_len   = params.EXTRUDE_LEN|default(120) |float %}

    RESPOND PREFIX="info" MSG="卸载灯丝 {extruder_temp} 为了 {extrude_len}mm 在 {speed/60} mm/s"
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}
    _IFS_VARS extruder_port=0
    SAVE_GCODE_STATE NAME=unload_state
    M83
    G92 E0
    _DISABLE_SENSORS
        G1 E-20 F{speed}
        G4 P5000
        G1 E-{(extrude_len-20)/2} F{speed}
        G1 E-{(extrude_len-20)/2} F{speed}
        M400
    _ENABLE_SENSORS
    RESTORE_GCODE_STATE NAME=unload_state


[gcode_macro _DISABLE_SENSORS]
gcode:
    SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=0

[gcode_macro _ENABLE_SENSORS]
gcode:
    SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=1
    SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=1

[gcode_macro BED_CALIBRATE]
gcode:
  {% set extruder_temp = params.EXTRUDER_TEMP|default(255) | float %}
  {% set bed_temp = params.BED_TEMP|default(70)|float %}
  
  M140 S{bed_temp}
  M104 S{extruder_temp}
  _G28
  BED_MESH_CLEAR
  _CLEAR_NOZZLE
  LOAD_CELL_TARE
  M190 S{bed_temp}
  BED_MESH_CALIBRATE PROFILE="auto"
  M140 S0
  M104 S0
  SAVE_CONFIG

[gcode_macro BED_SCREWS]
gcode:
  {% set extruder_temp = params.EXTRUDER_TEMP|default(255) | float %}

  M104 S{extruder_temp}
  _G28
  _CLEAR_NOZZLE
  LOAD_CELL_TARE
  SCREWS_TILT_CALCULATE
  M104 S0

[gcode_shell_command zrestore]
command: /opt/config/mod_data/plugins/lessWaste/restore_gcode.sh
timeout: 600.0
verbose: True

[gcode_macro _T_CURRENT]
gcode:
  {% set ifs = printer['gcode_macro _IFS_VARS'] %}
  {% if ifs.current_tool >= 0 %}
    T{ifs.current_tool}
  {% endif %}
   
# disabled zmod macros

#[delayed_gcode _TEST_RESTORE]
#initial_duration: 0
#gcode:
    #disabled

[gcode_macro _UGOL_PARK]
gcode:
    #disabled

[gcode_macro _PRINT_CLEAR_NOZZLE]
gcode:
    #disable

[gcode_macro _PRINT_IFS_MOTION]
gcode:
    #disabled

[gcode_macro _A_CHANGE_FILAMENT]
gcode:
  #disabled

[gcode_macro _START_MESH]
gcode:
  #disabled

[gcode_macro _IFS_AUTOINSERT]
gcode:
    #disabled

[gcode_shell_command zexclude]
command:#disabled
timeout: 120
verbose: True
